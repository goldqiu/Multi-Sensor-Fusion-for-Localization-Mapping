# 第9章：基于图优化的建图方法

## 课程内容

代码、PPT、视频见文件夹

### 课程笔记

#### 基于预积分的融合方案流程

##### 优化问题分析

![pic1](.\PIC\pic1.jpg)

##### 预积分的作用

![PIC2](.\PIC\PIC2.jpg)

##### 基于预积分的建图方案流程

由于此处讨论的优化方案包含组合导航系统，且认为外参已标定，因此会和常见的lio/vio中的方案有所不同，它不包含以下内容：

 1) 初始化lidar和IMU之间的外参；  (已标定)

 2) 初始化速度、陀螺仪bias等；（组合导航已经解决了这些问题，一般会提供）

 3) 初始化重力； （有了经纬高可以通过公式得到重力加速度）

 4) 世界坐标系对齐(组合导航已经对齐)。

![PIC3](.\PIC\PIC3.jpg)

#### 预积分模型设计

![pic4](.\PIC\pic4.jpg)

![pic5](.\PIC\pic5.jpg)

![pic6](.\PIC\pic6.jpg)

![PIC7](.\PIC\PIC7.jpg)

![PIC8](.\PIC\PIC8.jpg)

新的预积分值=老的预积分值+根据bias的变化量算出的新的预积分结果

#### 预积分在优化中的使用

##### 使用方法

![pic9](.\PIC\pic9.jpg)

##### 残差设计

![PIC10](.\PIC\PIC10.jpg)

![PIC11](.\PIC\PIC11.jpg)

##### 残差雅可比的推导

姿态残差的雅可比

![PIC12](.\PIC\PIC12.png)

![PIC13](.\PIC\PIC13.jpg)

![PIC14](E:\AUSIM\Localization\SynologyDrive\第9章：基于图优化的建图方法\PIC\PIC14.jpg)

![PIC15](.\PIC\PIC15.jpg)

![PIC16](.\PIC\PIC16.jpg)

![PIC17](.\PIC\PIC17.jpg)

##### 预积分方差计算

![PIC18](.\PIC\PIC18.jpg)

![PIC19](.\PIC\PIC19.jpg)

![PIC20](.\PIC\PIC20.jpg)

**离散时间下的传递方程**

![PIC21](.\PIC\PIC21.jpg)

![PIC22](.\PIC\PIC22.jpg)

![PIC23](.\PIC\PIC23.jpg)

![PIC24](.\PIC\PIC24.jpg)

![PIC25](.\PIC\PIC25.jpg)

![PIC26](.\PIC\PIC26.jpg)

![PIC27](.\PIC\PIC27.jpg)

![PIC28](.\PIC\PIC28.jpg)

![PIC29](.\PIC\PIC29.jpg)

##### 预积分更新

![PIC30](.\PIC\PIC30.jpg)

#### 典型方案介绍

##### LIO-SAM介绍

论文名称：LIO-SAM: Tightly-coupled Lidar Inertial Odometry via Smoothing and Mapping
代码地址：https://github.com/TixiaoShan/LIO-SAM

最大特点：分两步完成，先通过点云特征计算出相对位姿，再利用相对位姿、IMU预积分和GPS做融合。
相比于直接一步做紧耦合，大大提高了效率，而且实测性能也很优异。

##### 代码讲解

#### 融合编码器的优化方案

##### 整体思路介绍

![PIC31](.\PIC\PIC31.jpg)

##### 预积分模型设计

![PIC32](.\PIC\PIC32.jpg)

![PIC33](.\PIC\PIC33.jpg)

![PIC34](.\PIC\PIC34.jpg)

imu的bias比起编码器，需要考虑的原因是IMU具有零偏重复性和随机游走。

## 作业

在IMU的预积分中，课程只提供了残差对部分变量的雅可比，请推导残差对其它变量的雅可比，并在建图流程的代码中补全基于IMU预积分的融合方法中的待填内容，随后与不加IMU融合时的效果进行对比。

备注：
1) 对比是全方位的，既包括轨迹精度的对比，也包括地图质量的对比(因为IMU会增加估计的平滑性)；
2) 由于数据集的老问题，部分指标可能与预期不一致，且地图质量无法量化，因此给出自己的分析即可。

评价标准：
及格：公式推导正确，补全代码之后功能正常；
良好：在及格基础上，实现和不加IMU时的效果对比和分析；
优秀：在良好的基础上，完成融合编码器时预积分公式的推导(方差递推、残差对状态量雅可比、
bias更新等) 。


#### 附加题(不参与考核)： 

基于预积分的融合编码器的方法，近年来层出不穷，众多论文中给出了众多方法，请调研相关文献， 梳理不同的推导思路，并从原理上对比各种方案的不同于优缺点。 如有余力，在优秀作业的基础上，实现不同方案，并对比效果。


