# 第4章：点云地图构建及基于地图的定位

## 课程内容

代码、PPT、视频见文件夹

### 课程笔记

![pic1](E:\AUSIM\Localization\SynologyDrive\第4章：点云地图构建及基于地图的定位\PIC\pic1.jpg)

#### 回环检测：

目的：消除累计误差，并提高地图一致性。
方法：从历史帧中找出相似帧（即物理世界中相近位置且有充足共视区域的帧），并给出二者的相对位姿。
用法：在后端优化中，作为一个相对位姿约束的边，加入图优化系统中（后面详细讲述）。

![pic2](.\PIC\pic2.jpg)

##### 基于Scan Context

方法原理：

方法： LeGO-LOAM + scan context 闭环检测
代码：https://github.com/irapkaist/SC-LeGO-LOAM

应用案例：

论文题目：Scan Context: Egocentric Spatial Descriptor for Place Recognition within 3D Point Cloud Map
代码地址：https://github.com/irapkaist/scancontex

缺点：相对旋转，平移很难测准。

##### 基于直方图

论文题目：

A fast, complete, point cloud based loop closure for LiDAR odometryand mapping 

应用案例：

loam_livox 开源代码：https://github.com/hku-mars/loam_livox

#### 后端优化

##### 后端优化基本原理

目的：利用回环检测结果和惯导先验位姿修正里程计误差。
回环在此处提供的是两帧之间的相对位姿。

观测：
1) 连续两帧的相对位姿观测；
2) 回环匹配得到的相对位姿观测；
3) 组合导航提供的先验位姿观测。

使用方式：
a. 1)和2)的观测构成了基于回环的位姿修正；
b. 1)和3)的观测构成了基于先验观测的位姿修正；
c. 1) 2) 3) 也可以同时使用。

![pic3](.\PIC\pic3.jpg)

##### 李群、李代数基本知识

![pic4](.\PIC\pic4.png)

![pic5](.\PIC\pic5.jpg)

![pic6](.\PIC\pic6.jpg)

![pic7](.\PIC\pic7.jpg)

![pic8](.\PIC\pic8.jpg)

![pic9](.\PIC\pic9.jpg)

##### 基于回环的位姿修正

![pic10](.\PIC\pic10.jpg)

![pic11](.\PIC\pic11.jpg)

![pic12](.\PIC\pic12.jpg)

![pic13](.\PIC\pic13.jpg)

##### 基于先验观测的位姿修正

和相对位姿的区别：前者一个残差项连接了两个位姿，即两个位姿的相对位姿，后者则是一个绝对位姿。在优化中，前者为二元边，后者为一元边。

![pic14](.\PIC\pic14.jpg)

#### 点云地图建立

##### 整体流程

建图流程设计的核心原则是准确、高效地把里程计相对位 姿、回环相对位姿、惯导先验位姿进行融合。

![pic15](.\PIC\pic15.jpg)

##### 建图流程代码讲解

“低耦合、高内聚”变成思想的运用。

注意：代码要清晰，为了以后的效率高。

#### 基于地图的定位

##### 整体流程

在地图匹配中，鲁棒性和运行速度更加重要，因此实际使用中，基于NDT的匹配使用更广泛。

![pic16](.\PIC\pic16.jpg)

更新局部地图需要计算量，不用频繁更新局部地图，做一个判断是否更新局部地图。

##### 位姿初始化

由于NDT匹配需要较准确的初始位姿，因此在定位之前需要初始化环节，给出载体的初始位姿。
按照难度由低到高，常见的初始化需求有这样几种：
1) 已知位姿的初始化
2）位置已知而姿态位置的初始化
3）位置和姿态均未知的初始化

#### LeGO-LOAM

#####  主要特点

1) 对地面做了分割，减小了特征搜索范围；
2) 提取特征之前做了聚类，提高了特征质量；
3) 以帧为单位进行优化，使得全局地图可以多次调整，而不像LOAM那样不可修改；
4) 增加了回环修正。

##### 特征提取

1) 根据线与线之间的夹角，以及点的曲率，筛选出地面点。所有用于匹配的平面点仅使用地面点。
2) 在非地面点中，使用广度优先搜索(BFS)做聚类，聚类中点的数量大于30，才用来筛选线特征。
3) 筛选线特征方法，与LOAM中相同。

##### 位姿解算

1) 使用地面面特征优化高度和水平角；
2) 使用线特征优化水平位移和航向角。
注意：实际代码中，只有odom环节(scan-to-scan)使用了该模式，在mapping环节
(scan-to-map)仍使用的是六自由度模型。

猜测原因：1. scan-to-map是一个低频的优化任务，可以增加计算量

2. 在map情况下，线特征和地面的面特征经过叠加后都具有六自由度优化的必要了。

![pic17](.\PIC\pic17.jpg)

##### 回环检测与修正

1) 回环检测使用的初始位姿，采用前端里程计位姿
2) 匹配采用 ICP 方法
3) 优化库采用 gtsam

论文：LeGO-LOAM: Lightweight and Ground-Optimized Lidar Odometry and Mapping on 
Variable Terrain
代码：https://github.com/RobustFieldAutonomyLab/LeGO-LOAM

## 作业

1) 构建点云地图

使用提供的工程代码和bag文件，跑通建图过程，并保存地图。

2) 基于点云地图定位

实际使用时，载体可能处于地图中任意位置，而当雷达点云还没有开始和地图匹配时，它所处的精确位姿是未知的，往往
只有 gps 或组合导航提供的带有一定误差的粗略位姿。在任意位置，利用粗略位姿作为初始值，通过雷达点云和地图点
云匹配，得到精确初始位姿的过程，叫做全局初始化。
提供的作业框架中，只能完成在地图原点的初始化，而不能实现全局初始化，全局初始化的实现为作业内容。
作业要求提供在 bag 时间的 100s、200s、300s、400s 处初始化成功的截图。
提示：bag 可以在指定时间点（例如第100s）播放，指令为 ”rosbag play xxx.bag -s 100”

评价标准：

1) 及格：跑通建图流程、保存地图，并截图显示完整地图；
2) 良好：在建图的基础上，加载点云地图，实现在地图原点的初始化 (此功能提供的代码中已实现)；
3) 优秀：在建图的基础上，实现全局初始化的要求。

代码和文档见文件夹。

**注：**

需要重新生成基于自己基环境protobuf的proto：

打开lidar_localization/config/scan_context文件夹，输入如下命令，生成pb文件

```
protoc --cpp_out=./ key_frames.proto
protoc --cpp_out=./ ring_keys.proto
protoc --cpp_out=./ scan_contexts.proto
mv key_frames.pb.cc key_frames.pb.cpp
mv ring_keys.pb.cc ring_keys.pb.cpp
mv scan_contexts.pb.cc scan_contexts.pb.cpp
```

分别修改生成的三个.pb.cpp文件。如下，以ring_keys.pb.cpp为例。

```
// Generated by the protocol buffer compiler.  DO NOT EDIT!
// source: ring_keys.proto

#define INTERNAL_SUPPRESS_PROTOBUF_FIELD_DEPRECATION
#include "ring_keys.pb.h" 替换为  #include "lidar_localization/models/scan_context_manager/ring_keys.pb.h"

#include <algorithm>
```

之后，用以上步骤生成的的.pb.h文件替换lidar_localization/include/lidar_localization/models/scan_context_manager 中的同名文件。 将.pb.cpp文件替换（注意：需要剪切，确保config文件中新生成的文件都转移到对应目录下，不能重复出现）lidar_localization/src/models/scan_context_manager中的同名文件。

## 实验室实车实现	

代码和文档见文件夹。
